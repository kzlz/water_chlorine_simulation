基于GNN与贪心算法的管网水质传感器最优布局研究
1. 项目简介
本项目旨在解决一个核心的水务行业难题：如何利用少数监测点的数据，实时、准确地预测整个供水管网的余氯浓度分布。

研究以 EPANET 的经典管网模型 Net3 为对象，首先通过 Python 的 wntr 库进行二次开发，生成了包含多种工况的余氯时空分布数据集。在此基础上，我们逐步构建并优化了一个数据驱动的预测框架，其核心贡献在于系统性地验证了传感器优化布局在提升预测精度方面的巨大价值。

最终的严谨对比实验表明，通过算法优化的传感器布局方案，其预测性能相较于随机布局的平均水平有超过50%的显著提升，为经济、高效地部署管网监测系统提供了有力的科学依据。

2. 研究历程与方法论
本项目的研究遵循一个清晰的、分阶段的递进式路径。

第一阶段：基线模型建立
我们首先构建了一个融合**图神经网络（GNN）与门控循环单元（GRU）**的深度学习模型作为性能基准。GNN用于捕捉管网复杂的空间拓扑结构，GRU用于学习水质动态变化的时间依赖性。在随机选择5个传感器进行测试时，该模型验证了通过少点数据预测全网水质的技术可行性，为后续优化工作提供了可量化的比较标准。

第二阶段：传感器布局优化
在基线模型的基础上，我们引入了**贪心算法（Greedy Algorithm）**对传感器的空间布局进行优化。该算法从一个空集开始，通过循环迭代，在每一轮都将那个能为模型带来最大性能提升的节点加入最优传感器集合，直至达到目标数量。这一阶段的目标是，以数据驱动的方式，从90多个候选节点中找出信息量最大的5个“黄金”监测点。

第三阶段：严谨的科学验证
为了确保结论的科学性与公正性，我们设计了一套严格的最终验证流程。我们不仅将“最优布局”与“单次随机布局”进行比较，而是将其与10次不同随机布局的平均性能进行对比，以排除偶然性。

此外，该阶段的训练过程引入了验证集与早停（Early Stopping）机制，以防止模型过拟合；评估体系则采用了均方根误差（RMSE）、**平均绝对误差（MAE）和决定系数（R² Score）**等多维度指标，对结果进行全方位的综合评判。

3. 最终项目结构与执行流程
本项目的核心工作流由以下三个脚本按顺序执行，结构清晰，易于复现：

.
├── Net3.inp                           # [数据] 原始管网模型
├── 1_generate_dataset.py                # [第1步] 运行此脚本生成模拟数据集 (simulation_dataset.csv)
├── 2_optimize_sensors.py              # [第2步] 基于数据集，运行此脚本寻找最优传感器布局
└── 3_final_comparison_advanced.py     # [第3步] 对比验证最优布局与随机布局的性能
=======
基于GNN-GRU的供水管网余氯全域预测模型
1. 项目简介
本项目旨在解决一个核心的水务行业难题：如何利用少数监测点的数据，实时、准确地预测整个供水管网的余氯浓度分布。

我们首先使用 wntr 库对 EPANET 的经典管网模型 Net3 进行多次模拟，生成包含不同工况的余氯时空分布数据集。随后，我们构建了一个融合**图神经网络（GNN）和门控循环单元（GRU）**的深度学习模型，该模型能够：

利用 GNN 学习管网复杂的空间拓扑结构。

利用 GRU 捕捉水质动态变化的时间依赖性。

最终目标是训练一个能够仅根据少数几个传感器节点的数据，就能高精度推断出管网中所有节点余氯浓度的代理模型。

2. 项目结构
.
├── Net3.inp                # EPANET 原始管网模型文件
├── generate_dataset.py     # 脚本：运行多次模拟以生成数据集
├── train_gnn_gru.py        # 脚本：训练和评估 GNN-GRU 模型
├── simulation_dataset.csv  # 生成的模拟数据集 (运行 generate_dataset.py 后产生)
├── best_model.pth          # 训练好的最佳模型权重 (运行 train_gnn_gru.py 后产生)
└── README.md               # 本文档

3. 环境要求与安装
本项目在以下环境中开发和测试：

操作系统: Windows

Python 版本: 3.11+

主要依赖库:

wntr

pandas, numpy, scikit-learn

matplotlib

torch, torch_geometric

您可以通过以下命令快速安装所有必要的依赖库：

pip install wntr pandas numpy scikit-learn matplotlib torch torch_geometric

注意: torch_geometric 的安装可能依赖于您的 PyTorch 和 CUDA 版本。如果遇到问题，请参考其官方文档进行安装。

4. 使用方法
请按照以下步骤运行本项目：

第1步：生成模拟数据集
首先，我们需要运行多次模拟来创建一个包含多种工况的数据集。

python generate_dataset.py

该脚本会运行10次模拟（可在脚本内修改次数），并在项目根目录下生成 simulation_dataset.csv 文件。

第2步：训练并评估模型
数据集准备好后，运行主训练脚本：

python train_gnn_gru.py

该脚本会自动完成以下任务：

加载 Net3.inp 文件构建管网图结构。

加载 simulation_dataset.csv 并进行预处理。

随机选择5个节点作为“传感器”，用它们的历史数据作为输入。

训练 GNN-GRU 模型，目标是预测下一时刻所有节点的余氯浓度。

训练完成后，在测试集上评估模型性能，并保存最优模型为 best_model.pth。

生成并显示一张预测结果与真实值的对比图。

5. 当前进展
[已完成] 成功搭建并运行了 GNN-GRU 基线模型。

[已完成] 实现了完整的数据生成、预处理、模型训练和评估流程。

[下一步] 开展传感器最优布局研究，探索如何选择最有效的监测点组合以提升模型预测精度。
